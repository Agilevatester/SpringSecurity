package com.example.tomcatcve202524813;

import org.apache.catalina.session.FileStore;
import org.apache.catalina.session.PersistentManager;
import org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory;
import org.springframework.boot.web.server.WebServerFactoryCustomizer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;


@Configuration
public class TomcatConfiguration {


    @Bean
    public WebServerFactoryCustomizer<TomcatServletWebServerFactory> customizer() {
        return factory -> factory.addContextCustomizers(context -> {

            context.setSessionCookieName("JSESSIONID");

            // Configure for file-based session persistence
            PersistentManager persistentManager = new PersistentManager();
            FileStore fileStore = new FileStore();
            persistentManager.setStore(fileStore);
            context.setManager(persistentManager);

            // The Code below can also be used to register the defaultServlet instead of the ServletConfig

//            ServletContext servletContext = context.getServletContext();
//            Map<String, ? extends ServletRegistration> servletRegistrations = servletContext.getServletRegistrations();
//            ServletRegistration.Dynamic defaultServletRegistration = (ServletRegistration.Dynamic) servletRegistrations.get("default");
//            if (defaultServletRegistration != null) {
//                defaultServletRegistration.setInitParameter("readonly", "false");
//            }
//
//            // Map to root
//            defaultServletRegistration.addMapping("/*");
//            // Map the default servlet to handle all static content
//            context.addServletMappingDecoded("/", "default");
//            context.addServletMappingDecoded("*.html", "default");
//            context.addServletMappingDecoded("*.js", "default");
//            context.addServletMappingDecoded("*.css", "default");
//            context.addServletMappingDecoded("*.txt", "default");

        });
    }
}
